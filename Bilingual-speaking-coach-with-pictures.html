<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Picture WH-Questions + Recorder (Bilingual)</title>
<style>
  :root { --bg:#0b1a2a; --card:#0f2742; --text:#e7f2ff; --muted:#a9c6e8; --accent:#5cc7ff; --edge:#1d3a5c; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1000px;margin:auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h1{margin:0 0 8px;font-size:26px}
  .sub{color:var(--muted);margin:0 0 16px}
  .grid{display:grid;gap:16px}
  /* stage (image + questions) */
  .stage{display:grid;gap:16px}
  .title{font-weight:700}
  .canvas{position:relative;overflow:hidden;border:1px solid var(--edge);border-radius:14px;background:#0a1f39;min-height:280px}
  .img{width:100%;height:100%;object-fit:cover;display:block;max-height:420px}
  .btn{cursor:pointer;border:1px solid var(--edge);background:#102f52;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:700;min-width:140px}
  .btn.primary{background:linear-gradient(180deg,#169bf0,#1177c3);border:0}
  .panel{background:#0a1f39;border:1px solid var(--edge);border-radius:14px;padding:14px}
  ol.qs{margin:0;padding-left:20px}
  .qs li{margin:8px 0 12px}
  .q-es{display:block;color:#bfe0ff;opacity:.95;margin-top:2px}
  .hint{color:var(--muted);font-size:13px}
  @media (min-width:900px){ .stage{grid-template-columns:1.15fr .85fr} .canvas{min-height:380px} }
  /* recorder styles reused from coach */
  label{font-weight:600}
  input[type="text"], select, textarea{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a4771; background:#0a1f39; color:var(--text);
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .meter{height:10px;background:#0a1f39;border:1px solid #2a4771;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#12d6ff,#3ff2a8)}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:10px}
  .kpi .box{background:#0a1f39;border:1px solid #2a4771;border-radius:12px;padding:12px;text-align:center}
  .box .big{font-weight:800;font-size:22px}
  details{background:#0a1f39;border:1px solid #2a4771;border-radius:12px;padding:10px}
  audio{width:100%}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card grid">
    <div>
      <h1>Picture WH-Questions</h1>
      <p class="sub">Look at the picture. <strong>Answer the bilingual WH-questions.</strong> Then record your response.</p>
    </div>

    <!-- SCENE: image + questions -->
    <div class="stage" aria-label="Scene and questions">
      <section>
        <div class="title" id="sceneTitle">Scene • Zoo Visit</div>
        <figure class="canvas">
          <img id="sceneImg" class="img" src="" alt="Scene image">
        </figure>
        <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
          <button class="btn primary" id="btnPrompt">New Prompt</button>
          <span class="hint">Shows a new picture and bilingual questions.</span>
        </div>
      </section>
      <aside class="panel">
        <h3 style="margin:0 0 8px;">WH-Questions (EN + ES)</h3>
        <ol class="qs" id="qList"></ol>
        <span class="hint">Teacher note: replace image files in <code>/images/</code> and edit <code>SCENES</code> below.</span>
      </aside>
    </div>

    <!-- RECORDER: controls + transcript + metrics -->
    <div class="grid" aria-label="Recorder">
      <div class="row">
        <label for="student">Student name</label>
        <input id="student" placeholder="e.g., Alex R." autocomplete="name">
      </div>
      <div class="row">
        <label for="duration">Duration</label>
        <select id="duration">
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="90">90s</option>
        </select>
        <button class="btn primary" id="btnStart">Start Recording</button>
        <button class="btn" id="btnStop" disabled>Stop</button>
        <span id="status" class="hint">Idle</span>
      </div>
      <div class="meter" aria-label="Time remaining">
        <div class="bar" id="bar"></div>
      </div>

      <label for="transcript">Transcript (auto if supported; editable)</label>
      <textarea id="transcript" rows="6" placeholder="Auto transcript appears here (Chrome). You can edit before saving."></textarea>
      <span class="small">If transcription isn’t allowed, type a quick summary after speaking.</span>

      <div class="kpi" aria-label="Metrics">
        <div class="box"><div class="small">Words</div><div class="big" id="words">0</div></div>
        <div class="box"><div class="small">WPM</div><div class="big" id="wpm">0</div></div>
        <div class="box"><div class="small">Fillers</div><div class="big" id="fillers">0</div></div>
        <div class="box"><div class="small">Elapsed</div><div class="big" id="elapsed">0s</div></div>
      </div>

      <details>
        <summary>Audio & session data</summary>
        <div class="grid" style="margin-top:10px">
          <audio id="player" controls></audio>
          <div class="row">
            <button id="btnSave" class="btn primary" disabled>Save Session</button>
            <button id="btnExport" class="btn">Export CSV</button>
            <button id="btnClearData" class="btn">Clear Saved Sessions</button>
            <span class="hint" id="savedCount">0 sessions saved</span>
          </div>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
/* ========= SCENES (bilingual) ========= */
const SCENES = [
  {
    title: "Zoo Visit",
    src: "images/zoo-1.png",
    alt: "Children at a zoo entrance looking at animals",
    questions: [
      { en: "Who is standing closest to the giraffe?",                    es: "¿Quién está más cerca de la jirafa?" },
      { en: "What animal are the children looking at?",                   es: "¿Qué animal están mirando los niños?" },
      { en: "Where is the zebra in the picture?",                         es: "¿Dónde está la cebra en la imagen?" },
      { en: "When do you think they arrived at the zoo?",                 es: "¿Cuándo crees que llegaron al zoológico?" },
      { en: "How did they get to the zoo and why are they smiling?",      es: "¿Cómo llegaron al zoológico y por qué están sonriendo?" }
    ]
  },
  {
    title: "Sunny Beach",
    src: "images/beach-1.png",
    alt: "Families playing near the water with umbrellas on the sand",
    questions: [
      { en: "Who is building the sandcastle?",                            es: "¿Quién está construyendo el castillo de arena?" },
      { en: "What are people doing in the water?",                        es: "¿Qué están haciendo las personas en el agua?" },
      { en: "Where are the beach umbrellas located?",                     es: "¿Dónde están ubicadas las sombrillas de playa?" },
      { en: "When might it be safest to swim here?",                      es: "¿Cuándo podría ser más seguro nadar aquí?" },
      { en: "Why are people wearing hats and how are they staying safe?", es: "¿Por qué las personas llevan sombreros y cómo se están cuidando?" }
    ]
  },
  {
    title: "Classroom Time",
    src: "images/classroom-1.png",
    alt: "Students working in groups at desks with a teacher nearby",
    questions: [
      { en: "Who is giving instructions?",                                es: "¿Quién está dando instrucciones?" },
      { en: "What subjects might they be studying?",                      es: "¿Qué materias podrían estar estudiando?" },
      { en: "Where do you see group work happening?",                     es: "¿Dónde ves que están trabajando en grupo?" },
      { en: "When should students raise their hands?",                    es: "¿Cuándo deben levantar la mano los estudiantes?" },
      { en: "Why are some students writing and how could they help?",     es: "¿Por qué algunos estudiantes están escribiendo y cómo podrían ayudarse?" }
    ]
  },
  {
    title: "City Park",
    src: "images/park-1.png",
    alt: "People walking dogs and kids playing near trees and benches",
    questions: [
      { en: "Who is walking the dog?",                                    es: "¿Quién está paseando al perro?" },
      { en: "What games are the children playing?",                       es: "¿A qué juegos están jugando los niños?" },
      { en: "Where can you sit and rest in the park?",                    es: "¿Dónde puedes sentarte y descansar en el parque?" },
      { en: "When is the park likely most crowded?",                      es: "¿Cuándo es probable que el parque esté más lleno?" },
      { en: "Why are there signs on the path and how should people follow them?", es: "¿Por qué hay señales en el camino y cómo deben seguirlas las personas?" }
    ]
  },
  {
    title: "Family Kitchen",
    src: "images/kitchen-1.png",
    alt: "A family preparing food on a kitchen counter",
    questions: [
      { en: "Who is washing the vegetables?",                              es: "¿Quién está lavando las verduras?" },
      { en: "What tools are they using to cook?",                          es: "¿Qué utensilios están usando para cocinar?" },
      { en: "Where are the ingredients kept?",                             es: "¿Dónde se guardan los ingredientes?" },
      { en: "When should they clean the counter?",                         es: "¿Cuándo deben limpiar la encimera?" },
      { en: "Why are they cooking together and how does each person help?", es: "¿Por qué están cocinando juntos y cómo ayuda cada persona?" }
    ]
  }
];

/* ========= Scene logic ========= */
const $ = s => document.querySelector(s);
const sceneImg = $('#sceneImg');
const sceneTitle = $('#sceneTitle');
const qList = $('#qList');
const btnPrompt = $('#btnPrompt');

let order = shuffle([...Array(SCENES.length).keys()]);
let ptr = -1;
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function nextIndex(){ ptr++; if(ptr>=order.length){ order=shuffle(order); ptr=0; } return order[ptr]; }

function renderScene(i){
  const s = SCENES[i];
  sceneTitle.textContent = `Scene • ${s.title}`;
  sceneImg.style.objectFit = 'cover';
  sceneImg.src = s.src; sceneImg.alt = s.alt || s.title;
  qList.innerHTML = s.questions.map(q => `<li>${q.en}<span class="q-es">${q.es}</span></li>`).join('');
  currentScene = s; // save for session logging
}
sceneImg.addEventListener('error', () => {
  const s = currentScene || SCENES[0];
  sceneImg.style.objectFit = 'contain';
  sceneImg.src = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
      <rect width="100%" height="100%" fill="#0a1f39"/>
      <text x="50%" y="50%" fill="#a9c6e8" font-size="28" font-family="sans-serif" text-anchor="middle">
        Image not found: ${s.src}
      </text>
    </svg>
  `);
});
btnPrompt.addEventListener('click', ()=> renderScene(nextIndex()));
let currentScene = null;

/* ========= Recorder logic ========= */
let mediaRecorder, audioChunks = [];
let recognition, recognizing = false;
let startTime = 0, timerId = null, totalDuration = 60, elapsed = 0;
let audioBlobUrl = null;
const fillersSet = new Set(["um","uh","like","you know","er","ah","hmm"]);
const bar = $('#bar');

function sanitize(s){ return (s||"").replace(/\s+/g," ").trim(); }
function countWords(t){ const m = sanitize(t).match(/[A-Za-zÀ-ÖØ-öø-ÿ]+(?:'[A-Za-z]+)?/g); return m ? m.length : 0; }
function countFillers(t){
  const text = (" " + sanitize(t).toLowerCase() + " ");
  let c = 0; fillersSet.forEach(f => { const mm = text.match(new RegExp(`\\b${f}\\b`,'g')); if(mm) c+=mm.length; }); return c;
}
function updateMetrics(){
  const text = $('#transcript').value;
  const words = countWords(text);
  const wpm = elapsed ? Math.round(words / (elapsed/60)) : 0;
  $('#words').textContent = words;
  $('#wpm').textContent = wpm;
  $('#fillers').textContent = countFillers(text);
  $('#elapsed').textContent = `${Math.floor(elapsed)}s`;
}

/* Timer */
function startTimer(){
  startTime = performance.now(); elapsed = 0; bar.style.width='0%';
  timerId = requestAnimationFrame(function tick(ts){
    elapsed = (ts - startTime)/1000;
    const pct = Math.min(100, (elapsed/totalDuration)*100);
    bar.style.width = pct + '%';
    $('#elapsed').textContent = `${Math.floor(elapsed)}s`;
    updateMetrics();
    if(elapsed >= totalDuration){ stopAll(); return; }
    timerId = requestAnimationFrame(tick);
  });
}
function stopTimer(){ if(timerId){ cancelAnimationFrame(timerId); timerId=null; } }

/* MediaRecorder */
async function startRecording(){
  audioChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    if(audioBlobUrl) URL.revokeObjectURL(audioBlobUrl);
    audioBlobUrl = URL.createObjectURL(blob);
    $('#player').src = audioBlobUrl;
    $('#btnSave').disabled = false;
  };
  mediaRecorder.start();
}

/* Speech Recognition (Chrome) */
function startASR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ $('#status').textContent = 'Speech recognition not supported; you can still record audio or type notes.'; return; }
  recognition = new SR();
  recognition.lang = 'en-US';         // keep simple default
  recognition.interimResults = true;
  recognition.continuous = true;
  let finalText = '';
  recognition.onresult = (e) => {
    let interim = '';
    for(let i=e.resultIndex; i<e.results.length; i++){
      const tr = e.results[i][0].transcript;
      if(e.results[i].isFinal) finalText += tr + ' ';
      else interim += tr;
    }
    $('#transcript').value = (finalText + ' ' + interim).trim();
    updateMetrics();
  };
  recognition.onend = () => { recognizing = false; };
  recognition.onerror = () => { $('#status').textContent = 'ASR error; continue recording or type notes.'; };
  recognition.start(); recognizing = true;
}

/* Start / Stop */
async function startAll(){
  $('#btnStart').disabled = true;
  $('#btnStop').disabled = false;
  $('#btnSave').disabled = true;
  $('#status').textContent = 'Recording… speak clearly.';
  totalDuration = parseInt($('#duration').value,10);
  $('#transcript').value = ''; updateMetrics();
  try{ await startRecording(); }
  catch(e){ $('#status').textContent = 'Mic blocked or unavailable. You can still type the transcript.'; }
  startASR();
  startTimer();
}
function stopAll(){
  stopTimer();
  if(mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); }
  if(recognizing && recognition){ recognition.stop(); recognizing=false; }
  $('#btnStart').disabled = false;
  $('#btnStop').disabled = true;
  $('#status').textContent = 'Stopped. Review transcript and save.';
  updateMetrics();
}

/* Save / Export */
function getSaved(){ return JSON.parse(localStorage.getItem('speaking_sessions')||'[]'); }
function setSaved(a){ localStorage.setItem('speaking_sessions', JSON.stringify(a)); $('#savedCount').textContent = `${a.length} sessions saved`; }
function saveSession(){
  const row = {
    time: new Date().toISOString(),
    student: sanitize($('#student').value)||'Unknown',
    scene: currentScene ? currentScene.title : '',
    image: currentScene ? currentScene.src : '',
    questions_text: $('#qList').innerText,     // bilingual text shown
    duration_s: totalDuration,
    elapsed_s: Math.round(elapsed),
    words: parseInt($('#words').textContent,10)||0,
    wpm: parseInt($('#wpm').textContent,10)||0,
    fillers: parseInt($('#fillers').textContent,10)||0,
    transcript: $('#transcript').value
  };
  const list = getSaved(); list.push(row); setSaved(list);
  $('#status').textContent = 'Saved locally. Use Export CSV to share.';
}
function exportCSV(){
  const rows = getSaved();
  if(!rows.length){ alert('No saved sessions.'); return; }
  const headers = ["time","student","scene","image","questions_text","duration_s","elapsed_s","words","wpm","fillers","transcript"];
  const esc = v => `"${String(v).replace(/"/g,'""')}"`;
  const csv = [headers.join(",")].concat(rows.map(r => headers.map(h => esc(r[h]??"")).join(","))).join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'speaking_sessions.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function clearData(){ if(confirm('Delete all saved sessions from this browser?')){ localStorage.removeItem('speaking_sessions'); setSaved([]); }}

/* Wire up */
$('#btnPrompt').addEventListener('click', ()=> renderScene(nextIndex()));
$('#btnStart').addEventListener('click', startAll);
$('#btnStop').addEventListener('click', stopAll);
$('#btnSave').addEventListener('click', saveSession);
$('#btnExport').addEventListener('click', exportCSV);
$('#btnClearData').addEventListener('click', clearData);
$('#transcript').addEventListener('input', updateMetrics);
setSaved(getSaved());

/* First scene */
renderScene(nextIndex());
</script>
</body>
</html>
